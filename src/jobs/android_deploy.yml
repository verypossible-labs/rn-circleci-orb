description: Deploy Android via Fastlane.

parameters:
  checkout:
    description: Boolean for whether or not to checkout as a first step. Default is false.
    type: boolean
    default: false
  attach_workspace:
    description: Boolean for whether or not to attach to an existing workspace. Default is true.
    type: boolean
    default: true
  workspace_root:
    description: Workspace root path that is either an absolute path or a path relative to the working directory. Defaults to '.' (the working directory).
    type: string
    default: .
  persist_to_workspace:
    description: Should this job persist files to a workspace? Defaults to true
    type: boolean
    default: true
  bundle_type:
    description: The type of app to bundle, either 'aab' (Android App Bundles) or 'apk'. Google's recommendation is aab, which is the default.
    type: enum
    enum: ["aab", "apk"]
    default: "aab"
  fastlane_deploy_lane:
    description: The name of the fastlane lane used for deployment
    type: string
  fastlane_deploy_description:
    description: The description of the deploy lane running. ex. "Deploy Android app to Google Play Store (internal)."
    type: string
    default: ""
  on_after_initialize:
    description: A custom command to run right after yarn install.
    type: string
    default: ""

steps:
  - when:
      condition: <<parameters.checkout>>
      steps:
        - checkout

  - when:
      condition: <<parameters.attach_workspace>>
      steps:
        - attach_workspace:
            at: <<parameters.workspace_root>>

  - yarn_install

  - when:
      condition: <<parameters.on_after_initialize>>
      steps:
        - run:
            name: "on_after_initialize"
            command: <<parameters.on_after_initialize>>

  - fastlane:
      platform: "android"
      lane: <<parameters.fastlane_deploy_lane>>
      description: <<parameters.fastlane_deploy_description>>

  - when:
      condition: <<parameters.persist_to_workspace>>
      steps:
        - persist_to_workspace:
            root: .
            paths:
              - <<parameters.project_path>>/app/build/outputs/<<parameters.bundle_type>>

  - when:
      condition: <<parameters.store_artifacts>>
      steps:
        - store_artifacts:
            path: <<parameters.project_path>>/app/build/outputs/<<parameters.bundle_type>>
