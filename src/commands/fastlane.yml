description: Runs a Fastlane lane for a given platform.

parameters:
  platform:
    description: The platform to deploy, either "android" or "ios".
    type: enum
    enum: ["android", "ios"]
    default: "ios"
  lane:
    description: The fastlane lane to run for deployment.
    type: string
    default: "beta"
  description:
    description: Descriptor of the Fastlane lane running
    type: string
    default: ""

steps:
  - yarn_install

  - when:
      condition:
        equal: [ios, <<parameters.platform>>]
      steps:
        - install_pods

  - restore_cache:
      key: 1-gems-{{ checksum "Gemfile.lock" }}

  - run:
      name: Install gems from Gemfile.lock
      command: bundle check || bundle install --path vendor/bundle

  - run:
      name: Install Fastlane plugins
      command: fastlane install_plugins

  - save_cache:
      key: 1-gems-{{ checksum "Gemfile.lock" }}
      paths:
        - vendor/bundle

  - run:
      name: <<parameters.description>>
      command: bundle exec fastlane <<parameters.platform>> <<parameters.lane>>
